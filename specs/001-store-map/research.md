# Research: Store Map with Crowd Levels

**Feature**: 001-store-map | **Phase**: 0 (Research) | **Date**: 2026-01-07

## Research Goals

1. Validate React Leaflet compatibility with Next.js 15 App Router
2. Investigate geocoding options for address input (Nominatim)
3. Research PWA implementation with next-pwa
4. Determine localStorage strategy for weighted reporting & historical patterns
5. Identify WCAG 2.1 AA requirements for map accessibility

---

## 1. React Leaflet + Next.js App Router

### Findings

**Challenge**: React Leaflet requires `window` object, not available during SSR.

**Solution**: Dynamic import with `ssr: false` in client components:

```typescript
const MapComponent = dynamic(() => import('@/components/map/StoreMap'), {
  ssr: false,
  loading: () => <div>Kaart laden...</div>,
});
```

**Recommended Version**: React Leaflet 4.2.1 + Leaflet 1.9.4

**Key Dependencies**:

- `react-leaflet`: ^4.2.1
- `leaflet`: ^1.9.4
- `@types/leaflet`: ^1.9.8

**Tile Provider**: OpenStreetMap (free, no API key)

```
https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png
```

**References**:

- https://react-leaflet.js.org/docs/start-setup/
- https://nextjs.org/docs/app/building-your-application/optimizing/lazy-loading

---

## 2. Geocoding with Nominatim

### Findings

**Service**: Nominatim (OSM geocoding, free)

**Endpoint**: `https://nominatim.openstreetmap.org/search`

**Rate Limit**: 1 request/second (acceptable for MVP)

**Usage Policy**: Must include User-Agent header with app name

**Example Request**:

```
GET https://nominatim.openstreetmap.org/search?
  q=Marktstraat+10+Amsterdam&
  format=json&
  limit=1
```

**Response**:

```json
[
  {
    "lat": "52.3676",
    "lon": "4.9041",
    "display_name": "Marktstraat 10, Amsterdam"
  }
]
```

**Error Handling**:

- No results → "Adres niet gevonden"
- Multiple results → Use first result
- Network error → Fallback to manual map pan

**Alternative**: Google Geocoding API (requires billing, not MVP-appropriate)

**References**:

- https://nominatim.org/release-docs/latest/api/Search/
- https://operations.osmfoundation.org/policies/nominatim/

---

## 3. PWA Implementation

### Findings

**Plugin**: `next-pwa` v5.6.0

**Installation**:

```bash
npm install next-pwa
```

**Configuration** (`next.config.js`):

```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
});

module.exports = withPWA({
  // Next.js config
});
```

**Manifest** (`app/manifest.json`):

```json
{
  "name": "CrowdEase",
  "short_name": "CrowdEase",
  "description": "Vind rustige winkels in de buurt",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#10b981",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

**Offline Strategy**:

- Cache map tiles (NetworkFirst)
- Cache store data in localStorage
- Show offline.html if no connection

**Service Worker**: Auto-generated by next-pwa

**References**:

- https://github.com/shadowwalker/next-pwa
- https://web.dev/learn/pwa/

---

## 4. localStorage Strategy for Weighted Reporting

### Data Structure

**CrowdReports** (key: `crowdReports`):

```typescript
[
  {
    storeId: 'store_001',
    crowdLevel: 'rustig', // druk | matig | rustig
    timestamp: 1704643200000,
    reportWeight: 1.0, // 1.0 = GPS, 0.7 = non-GPS
    dayOfWeek: 6, // 0-6 (Sunday = 0)
    hourOfDay: 11, // 0-23
  },
];
```

**HistoricalPatterns** (key: `historicalPatterns`):

```typescript
[
  {
    storeId: 'store_001',
    dayOfWeek: 6,
    hourOfDay: 11,
    averageCrowdLevel: 0.75, // 0-1 scale
    reportCount: 8,
    lastUpdated: 1704643200000,
  },
];
```

**SavedAddress** (key: `savedAddress`):

```typescript
{
  street: "Marktstraat 10",
  city: "Amsterdam",
  postalCode: "1012 AB"
}
```

**LastReportTimestamp** (key: `lastReportTime`):

```typescript
1704643200000; // Single timestamp
```

### Storage Limits

- localStorage max: ~5-10MB (varies by browser)
- Estimated usage: ~500KB for 1000 reports
- Cleanup strategy: Remove reports older than retention period on write

### Privacy Considerations

✅ **Allowed**: storeId, crowdLevel, timestamp, weight, day, hour  
❌ **Forbidden**: GPS coordinates, user ID, device ID, IP address

**References**:

- https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage

---

## 5. WCAG 2.1 AA Map Accessibility

### Requirements

**Keyboard Navigation**:

- Tab through markers: Use `tabindex="0"` on markers
- Enter/Space to activate: Open popup on keypress
- Arrow keys for map pan: Implement custom keyboard controls

**Screen Reader Support**:

- Marker labels: `aria-label="Albert Heijn, Rustig, 2 minuten lopen"`
- Map region: `role="region" aria-label="Kaart van winkels in de buurt"`
- Live updates: `aria-live="polite"` for crowd level changes

**Color Contrast**:

- Crowd indicators: Red (#DC2626), Yellow (#FBBF24), Green (#10B981)
- Contrast ratios: All >4.5:1 against white background
- Don't rely on color alone: Add text labels + icons

**Focus Indicators**:

- Visible focus ring: 2px solid outline with 3px offset
- Focus trap in popups: Keep focus within modal

**Alternative Text**:

- Store images: Descriptive alt text (if icons used)
- Map loading: "Kaart laden..." placeholder

**Testing Tools**:

- axe DevTools (automated)
- NVDA/VoiceOver (manual)
- Keyboard-only navigation test

**References**:

- https://www.w3.org/WAI/WCAG21/quickref/
- https://www.w3.org/WAI/tutorials/maps/

---

## 6. Historical Pattern Algorithm

### Approach

**Aggregation**:

1. Group reports by `storeId + dayOfWeek + hourOfDay`
2. Calculate weighted average: `Σ(crowdLevel × weight) / Σ(weight)`
3. Require minimum 5 reports before showing pattern
4. Update patterns daily at midnight (simulated)

**Crowd Level Mapping**:

- rustig: 0.0 - 0.33
- matig: 0.34 - 0.66
- druk: 0.67 - 1.0

**Combining Real-time + Historical**:

```typescript
if (recentReports.length > 0) {
  // Use weighted average of reports in last 30 min
  level = calculateWeightedAverage(recentReports);
  source = 'real-time';
} else if (hasHistoricalPattern(store, now)) {
  // Fall back to pattern for current day/hour
  level = getHistoricalPattern(store, now);
  source = 'historical';
} else {
  level = null;
  source = 'none';
}
```

**Retention Logic**:

```typescript
// Run on app startup and after each report
function cleanupReports() {
  const now = Date.now();
  const reports = getReports();

  const cleaned = reports.filter((r) => {
    if (r.reportWeight === 0.7) {
      // Non-GPS: keep 24 hours
      return now - r.timestamp < 24 * 60 * 60 * 1000;
    } else {
      // GPS: keep 7 days
      return now - r.timestamp < 7 * 24 * 60 * 60 * 1000;
    }
  });

  saveReports(cleaned);
  aggregatePatternsIfNeeded();
}
```

---

## Technical Risks & Mitigations

| Risk                                 | Impact | Likelihood | Mitigation                                     |
| ------------------------------------ | ------ | ---------- | ---------------------------------------------- |
| React Leaflet SSR issues             | High   | Medium     | Use `dynamic` import with `ssr: false`         |
| Nominatim rate limiting              | Medium | Low        | Debounce requests, cache results               |
| localStorage quota exceeded          | Medium | Low        | Implement cleanup on write, monitor usage      |
| Map performance on mobile            | Medium | Medium     | Limit visible markers to 50, cluster if needed |
| Geocoding inaccuracy                 | Low    | Medium     | Accept first result, allow manual correction   |
| Historical patterns with sparse data | Low    | High       | Require min 5 reports, show "onvoldoende data" |

---

## Recommended Next Steps

1. ✅ Set up Next.js 15 project with TypeScript
2. ✅ Install React Leaflet + next-pwa dependencies
3. ✅ Create mock store data (~60 stores in Gent area)
4. → Proceed to **Phase 1: Data Model & Contracts**

**Phase 0 Complete**: All research validates technical feasibility. No blockers identified.
